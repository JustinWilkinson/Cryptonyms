@page "/Words"

@inject HttpClient Http
@inject IJSRuntime JSRuntime

<h1>Words</h1>

@if (allWords == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="content">
        @if (showCreateNewWord)
        {
            <div class="modal d-block" tabindex="-1" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Create New Word</h5>
                            <button type="button" class="close" @onclick="CloseNewWordPopup"><span aria-hidden="true">X</span></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <input id="newWord" type="text" class="form-control" @bind="NewWord" />
                                @if (createNewWordErrorMessage != null)
                                {
                                    <label class="text-danger m-2">@createNewWordErrorMessage</label>
                                }
                            </div>
                            <button id="saveNewWord" type="button" class="btn btn-primary" @onclick="AddNewWordAsync">Save</button>
                        </div>
                    </div>
                </div>
            </div>
        }
        <div class="form-row">
            <label class="m-2">Search:</label>
            <input id="searchTerm" type="text" class="form-control col-sm-3 col-lg-3" value="@searchTerm" @oninput="e => SearchWords(e.Value.ToString())" @onkeydown="e => BlurSearchFieldIfEnterOrEscapeAsync(e)" />
            <label class="m-2">Found @searchedWords.Count known words.</label>
            <button type="button" class="btn btn-primary mb-2" @onclick="() => { showCreateNewWord = true; }">Add New Word</button>
        </div>
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Word</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var word in searchedWords.OrderBy(w => w, StringComparer.OrdinalIgnoreCase))
                {
                    <CascadingValue Value="this">
                        <WordRow Word="@word" />
                    </CascadingValue>
                }
            </tbody>
        </table>

    </div>
}

@code {
    private List<string> allWords;
    private List<string> searchedWords;
    private HashSet<string> loweredWords;
    private string searchTerm = "";

    private bool showCreateNewWord = false;
    private string createNewWordErrorMessage;
    private string NewWord { get; set; }

    protected override async Task OnInitializedAsync()
    {
        allWords = JsonConvert.DeserializeObject<IEnumerable<string>>(await Http.GetStringAsync("api/Word/List")).ToList();
        loweredWords = allWords.Select(w => w.ToLowerInvariant()).ToHashSet();
        searchedWords = allWords;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (showCreateNewWord)
        {
            await JSRuntime.InvokeVoidAsync("codenames.setFocus", "newWord");
        }
    }

    private async Task BlurSearchFieldIfEnterOrEscapeAsync(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || e.Key == "Escape")
        {
            await JSRuntime.InvokeVoidAsync("codenames.blurElement", "searchTerm");
        }
    }

    private void SearchWords(string newSearchTerm)
    {
        searchTerm = newSearchTerm;
        if (!string.IsNullOrEmpty(searchTerm))
        {
            searchedWords = allWords.Where(w => w.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)).ToList();
        }
        else
        {
            searchedWords = allWords;
        }
    }

    private void CloseNewWordPopup()
    {
        showCreateNewWord = false;
        NewWord = null;
        createNewWordErrorMessage = null;
    }

    private async Task AddNewWordAsync()
    {
        var validationMessage = GetValidationMessage(NewWord);

        if (validationMessage == null)
        {
            allWords.Add(NewWord);
            loweredWords.Add(NewWord.ToLowerInvariant());
            await Http.PutJsonAsync("api/Word/New", NewWord);
            CloseNewWordPopup();
        }
        else
        {
            createNewWordErrorMessage = validationMessage;
        }
    }

    public void RemoveWord(string word)
    {
        allWords.Remove(word);
        loweredWords.Remove(word.ToLowerInvariant());
        StateHasChanged();
    }

    public void AddEditedWord(string word)
    {
        allWords.Add(word);
        loweredWords.Add(word.ToLowerInvariant());
    }

    public string GetValidationMessage(string word)
    {
        if (string.IsNullOrWhiteSpace(word))
        {
            return "Please enter a non-empty word!";
        }
        else if (loweredWords.Contains(word.ToLowerInvariant()))
        {
            return $"'{word}' is already in the list!";
        }
        else
        {
            return null;
        }
    }
}
